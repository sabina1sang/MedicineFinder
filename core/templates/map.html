{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h2>Pharmacy Map</h2>
    <p>Showing all approved pharmacies with their locations.</p>
    <div id="map" style="height: 500px;"></div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Create map (default center in Nepal just in case thereâ€™s no data)
    const map = L.map('map').setView([28.3949, 84.1240], 7);

    // Add OSM tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Fetch pharmacies from API
    fetch("{% url 'pharmacy_list_api' %}")
        .then(response => response.json())
        .then(data => {
            const markers = [];

            data.forEach(pharmacy => {
                if (pharmacy.latitude && pharmacy.longitude) {
                    const lat = parseFloat(pharmacy.latitude);
                    const lng = parseFloat(pharmacy.longitude);

                    const marker = L.marker([lat, lng]).addTo(map);
                    marker.bindPopup(`
                        <strong>${pharmacy.name}</strong><br>
                        ${pharmacy.address || ''}<br>
                        ðŸ“ž ${pharmacy.phone || 'N/A'}
                    `);

                    markers.push([lat, lng]);
                }
            });

            // If we have any markers, fit the map view to show them all
            if (markers.length > 0) {
                map.fitBounds(markers);
            }
        })
        .catch(error => console.error('Error fetching pharmacies:', error));
});
</script>

{% endblock %}
